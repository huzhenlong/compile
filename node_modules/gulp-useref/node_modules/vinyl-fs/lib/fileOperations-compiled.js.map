{"version":3,"sources":["fileOperations.js"],"names":[],"mappings":"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","file":"fileOperations-compiled.js","sourcesContent":["'use strict';\n\nvar fs = require('graceful-fs');\nvar assign = require('object-assign');\nvar isEqual = require('lodash.isequal');\nvar isValidDate = require('vali-date');\n\n// TODO shared module\n// TODO include sticky/setuid/setgid, i.e. 7777?\nvar MASK_MODE = parseInt('0777', 8);\nvar DEFAULT_FILE_MODE = parseInt('0666', 8);\nvar APPEND_MODE_REGEXP = /a/;\n\nfunction closeFd(propagatedErr, fd, callback) {\n  if (typeof fd !== 'number') {\n    return callback(propagatedErr);\n  }\n\n  fs.close(fd, onClosed);\n\n  function onClosed(closeErr) {\n    if (propagatedErr || closeErr) {\n      return callback(propagatedErr || closeErr);\n    }\n\n    callback();\n  }\n}\n\nfunction getModeDiff(fsMode, vinylMode) {\n  var modeDiff = 0;\n\n  if (typeof vinylMode === 'number') {\n    modeDiff = (vinylMode ^ fsMode) & MASK_MODE;\n  }\n\n  return modeDiff;\n}\n\nfunction getTimesDiff(fsStat, vinylStat) {\n\n  if (!isValidDate(vinylStat.mtime)) {\n    return;\n  }\n\n  if (isEqual(vinylStat.mtime, fsStat.mtime) &&\n      isEqual(vinylStat.atime, fsStat.atime)) {\n    return;\n  }\n\n  var atime;\n  if (isValidDate(vinylStat.atime)) {\n    atime = vinylStat.atime;\n  } else {\n    atime = fsStat.atime;\n  }\n\n  if (!isValidDate(atime)) {\n    atime = undefined;\n  }\n\n  var timesDiff = {\n    mtime: vinylStat.mtime,\n    atime: atime,\n  };\n\n  return timesDiff;\n}\n\nfunction isOwner(fsStat) {\n  var hasGetuid = (typeof process.getuid === 'function');\n  var hasGeteuid = (typeof process.geteuid === 'function');\n\n  // If we don't have either, assume we don't have permissions.\n  // This should only happen on Windows.\n  // Windows basically noops fchmod and errors on futimes called on directories.\n  if (!hasGeteuid && !hasGetuid) {\n    return false;\n  }\n\n  var uid;\n  if (hasGeteuid) {\n    uid = process.geteuid();\n  } else {\n    uid = process.getuid();\n  }\n\n  if (fsStat.uid !== uid && uid !== 0) {\n    return false;\n  }\n\n  return true;\n}\n\nfunction updateMetadata(fd, file, callback) {\n\n  fs.fstat(fd, onStat);\n\n  function onStat(err, stat) {\n    if (err) {\n      return callback(err, fd);\n    }\n\n    // Check if mode needs to be updated\n    var modeDiff = getModeDiff(stat.mode, file.stat.mode);\n\n    // Check if atime/mtime need to be updated\n    var timesDiff = getTimesDiff(stat, file.stat);\n\n    // Set file.stat to the reflect current state on disk\n    assign(file.stat, stat);\n\n    // Nothing to do\n    if (!modeDiff && !timesDiff) {\n      return callback(null, fd);\n    }\n\n    // Check access, `futimes` and `fchmod` only work if we own the file,\n    // or if we are effectively root.\n    if (!isOwner(stat)) {\n      return callback(null, fd);\n    }\n\n    if (modeDiff) {\n      return mode();\n    }\n    times();\n\n    function mode() {\n      var mode = stat.mode ^ modeDiff;\n\n      fs.fchmod(fd, mode, onFchmod);\n\n      function onFchmod(fchmodErr) {\n        if (!fchmodErr) {\n          file.stat.mode = mode;\n        }\n        if (timesDiff) {\n          return times(fchmodErr);\n        }\n        callback(fchmodErr, fd);\n      }\n    }\n\n    function times(fchmodErr) {\n      fs.futimes(fd, timesDiff.atime, timesDiff.mtime, onFutimes);\n\n      function onFutimes(futimesErr) {\n        if (!futimesErr) {\n          file.stat.atime = timesDiff.atime;\n          file.stat.mtime = timesDiff.mtime;\n        }\n        callback(fchmodErr || futimesErr, fd);\n      }\n    }\n  }\n}\n\n/*\n  Custom writeFile implementation because we need access to the\n  file descriptor after the write is complete.\n  Most of the implementation taken from node core.\n */\nfunction writeFile(path, data, options, callback) {\n  if (typeof options === 'function') {\n    callback = options;\n    options = {};\n  }\n\n  if (!Buffer.isBuffer(data)) {\n    callback(new TypeError('Data must be a Buffer'));\n    return;\n  }\n\n  if (!options) {\n    options = {};\n  }\n\n  // Default the same as node\n  var mode = options.mode || DEFAULT_FILE_MODE;\n  var flag = options.flag || 'w';\n  var position = APPEND_MODE_REGEXP.test(flag) ? null : 0;\n\n  fs.open(path, flag, mode, onOpen);\n\n  function onOpen(err, fd) {\n    if (err) {\n      return onComplete(err);\n    }\n\n    fs.write(fd, data, 0, data.length, position, onComplete);\n\n    function onComplete(err) {\n      callback(err, fd);\n    }\n  }\n}\n\nmodule.exports = {\n  closeFd: closeFd,\n  getModeDiff: getModeDiff,\n  getTimesDiff: getTimesDiff,\n  isOwner: isOwner,\n  updateMetadata: updateMetadata,\n  writeFile: writeFile,\n};\n"]}